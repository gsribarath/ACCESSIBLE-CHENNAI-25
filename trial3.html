<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Navigate - Accessible Chennai</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0b596c;
      --primary-dark: #106e8d;
      --accent: #f59e0b;
      --success: #10b981;
      --danger: #ef4444;
      --blue-gradient: linear-gradient(135deg, #0a4861 0%, #145974 100%);
      --glow-blue: 0 0 20px rgba(59, 130, 246, 0.5);
      --glow-accent: 0 0 15px rgba(245, 158, 11, 0.6);
    }

    * {
      scroll-behavior: smooth;
    }

    body {
      background: linear-gradient(135deg, #08354a 0%, #05374e 25%, #0e4e6c 50%, #0d5565 75%, #0e5f71 100%);
      background-size: 400% 400%;
      animation: gradientFlow 15s ease infinite;
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
    }

    @keyframes gradientFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .glass-strong {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .glow-primary {
      box-shadow: var(--glow-blue);
      transition: all 0.3s ease;
    }

    .glow-primary:hover {
      box-shadow: 0 0 30px rgba(59, 130, 246, 0.8);
      transform: translateY(-2px);
    }

    .glow-accent {
      box-shadow: var(--glow-accent);
    }

    .voice-toggle {
      position: relative;
      width: 80px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .voice-toggle.active {
      background: var(--blue-gradient);
      box-shadow: var(--glow-blue);
      border-color: #3b82f6;
    }

    .voice-toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 30px;
      height: 30px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .voice-toggle.active .voice-toggle-slider {
      transform: translateX(40px);
      background: #fff;
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
    }

    .audio-wave {
      display: none;
      position: absolute;
      right: -30px;
      top: 50%;
      transform: translateY(-50%);
    }

    .voice-toggle.active .audio-wave {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .wave-bar {
      width: 3px;
      height: 15px;
      background: #3b82f6;
      border-radius: 2px;
      animation: waveAnimation 1.5s ease-in-out infinite;
    }

    .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; }

    @keyframes waveAnimation {
      0%, 100% { height: 10px; opacity: 0.3; }
      50% { height: 25px; opacity: 1; }
    }

    .route-card {
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.6s ease;
    }

    .route-card.show {
      transform: translateY(0);
      opacity: 1;
    }

    .route-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .parallax-section {
      transform: translateY(50px);
      opacity: 0;
      transition: all 0.8s ease;
    }

    .parallax-section.visible {
      transform: translateY(0);
      opacity: 1;
    }

    .transit-icon {
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    .live-border {
      border: 2px solid transparent;
      background: linear-gradient(45deg, #3b82f6, #60a5fa) border-box;
      background-clip: padding-box, border-box;
      animation: borderGlow 3s ease-in-out infinite;
    }

    @keyframes borderGlow {
      0%, 100% { border-color: rgba(59, 130, 246, 0.5); }
      50% { border-color: rgba(59, 130, 246, 1); }
    }

    .route-card.selected {
      animation: routeSelect 0.8s ease;
    }

    @keyframes routeSelect {
      0% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.05) rotate(2deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    .hover-light {
      position: relative;
      overflow: hidden;
    }

    .hover-light::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .hover-light:hover::before {
      left: 100%;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    button:focus, input:focus, select:focus {
      outline: 3px solid #f59e0b;
      outline-offset: 2px;
    }

    .refresh-indicator {
      display: inline-block;
      animation: rotate 2s linear infinite;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .slide-in-left {
      transform: translateX(-50px);
      opacity: 0;
      transition: all 0.6s ease;
    }

    .slide-in-left.show {
      transform: translateX(0);
      opacity: 1;
    }

    .slide-in-right {
      transform: translateX(50px);
      opacity: 0;
      transition: all 0.6s ease;
    }

    .slide-in-right.show {
      transform: translateX(0);
      opacity: 1;
    }

    .map-redirect-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .map-redirect-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 2rem;
      border-radius: 1rem;
      text-align: center;
      max-width: 400px;
      animation: bounceIn 0.6s ease;
    }

    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }

    .voice-guide-button {
      animation: pulseGlow 2s ease-in-out infinite;
    }

    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 10px rgba(59, 130, 246, 0.4); }
      50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); }
    }

    /* Dropdown Styling */
    select {
      appearance: none;
      background-color: #FFFFFF;
      color: #000000;
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #3b82f6;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    select:focus {
      border-color: #f59e0b;
      box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
      transform: scale(1.02);
    }

    select option {
      padding: 10px;
      background-color: #FFFFFF;
      color: #000000;
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
    }

    select option:hover {
      background-color: #e0f7ff;
      color: #000000;
      font-weight: 600;
    }

    select option:checked {
      background-color: #e0f7ff;
      transform: scale(1.05);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }

    select::-webkit-scrollbar {
      width: 8px;
    }

    select::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    select::-webkit-scrollbar-thumb {
      background: #3b82f6;
      border-radius: 4px;
    }

    /* Speech Display */
    .speech-display {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 20px;
      max-width: 600px;
      min-width: 300px;
      z-index: 999;
      opacity: 0;
      transform: translateX(-50%) translateY(-20px);
      transition: all 0.3s ease;
      text-align: center;
    }

    .speech-display.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Voice Commands Panel */
    .voice-commands {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 20px;
      max-width: 300px;
      z-index: 999;
      opacity: 1;
      transform: translateX(0);
      transition: all 0.3s ease;
    }

    .voice-commands.hidden {
      opacity: 0;
      transform: translateX(20px);
      pointer-events: none;
    }

    /* Voice highlight */
    .voice-highlight {
      background-color: rgba(14, 165, 233, 0.3) !important;
      border: 2px solid #0ea5e9 !important;
      border-radius: 8px;
      animation: highlight-pulse 2s ease-in-out;
    }

    @keyframes highlight-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Loading animation */
    .loading-dots::after {
      content: '';
      animation: loadingDots 1.5s infinite;
    }

    @keyframes loadingDots {
      0% { content: ''; }
      25% { content: '.'; }
      50% { content: '..'; }
      75% { content: '...'; }
      100% { content: ''; }
    }

    @media (max-width: 768px) {
      select {
        font-size: 14px;
        padding: 10px;
        max-height: 150px;
      }

      .voice-toggle {
        width: 60px;
        height: 30px;
      }
      
      .voice-toggle-slider {
        width: 24px;
        height: 24px;
      }
      
      .voice-toggle.active .voice-toggle-slider {
        transform: translateX(30px);
      }
    }

    @media (prefers-contrast: high) {
      .glass, .glass-strong {
        background: rgba(255, 255, 255, 0.9);
        color: #000;
      }

      select {
        background-color: #FFFFFF;
        color: #000000;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body class="text-white">
  <!-- Speech Display -->
  <div class="speech-display" id="speechDisplay">
    <h3 class="text-white font-bold mb-2">
      <i class="fas fa-microphone mr-2 text-blue-400"></i> You said:
    </h3>
    <p class="text-lg text-gray-300" id="speechText">Listening...</p>
  </div>

  <!-- Voice Commands Help Panel -->
  <div class="voice-commands hidden" id="voiceCommands">
    <h3 class="text-white font-bold mb-3 text-lg">
      <i class="fas fa-microphone mr-2 text-blue-400"></i> Voice Commands
    </h3>
    <div class="space-y-2 text-sm text-gray-300">
      <div><span class="text-blue-400">"Help"</span> - Show all commands</div>
      <div><span class="text-green-400">"Navigate"</span> - Plan a journey</div>
      <div><span class="text-cyan-400">"Home"</span> - Go to home page</div>
      <div><span class="text-orange-400">"Alerts"</span> - Go to alerts page</div>
      <div><span class="text-red-400">"Stop"</span> - Stop current action</div>
      <div><span class="text-yellow-400">"Start Navigation"</span> - Start navigation for selected route</div>
      <div><span class="text-purple-400">"Find Route"</span> - Find accessible routes</div>
    </div>
    <button onclick="toggleCommandsPanel()" class="mt-3 text-xs text-gray-400 hover:text-white">Hide Commands</button>
  </div>

  <!-- Skip to content link -->
  <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:px-4 focus:py-2 focus:bg-white focus:text-blue-600 focus:rounded-md focus:z-50">
    Skip to main content
  </a>

  <!-- Header -->
  <header class="fixed top-0 w-full z-50 glass backdrop-blur-xl">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <a href="home.html" class="flex items-center space-x-1 focusable rounded-md" aria-label="Accessible Chennai Home" data-voice-nav="home">
            <div class="w-20 h-20 rounded-full flex items-center justify-center">
              <img src="ACCESSIBLECHENNAII.png" alt="Accessible Chennai Logo" class="w-16 h-16 object-cover rounded-full">
            </div>
            <h1 class="text-2xl font-bold">Accessible<span class="bg-gradient-to-r from-blue-300 to-cyan-300 bg-clip-text text-transparent"> Chennai</span></h1>
          </a>
        </div>
        <nav>
          <a href="home.html" class="text-blue-200 hover:text-white mx-3 focusable" onpointerenter="announceToUser('Home')" aria-label="Home" data-voice-nav="home">Home</a>
          <a href="navigate.html" class="text-white font-semibold mx-3 focusable" onpointerenter="announceToUser('Navigate')" aria-label="Navigate" data-voice-nav="navigate">Navigate</a>
          <a href="community.html" class="text-blue-200 hover:text-white mx-3 focusable" onpointerenter="announceToUser('Community')" aria-label="Community" data-voice-nav="community">Community</a>
          <a href="alerts.html" class="text-blue-200 hover:text-white mx-3 focusable" onpointerenter="announceToUser('Alerts')" aria-label="Alerts" data-voice-nav="alerts">Alerts</a>
          <a href="settings.html" class="text-blue-200 hover:text-white mx-3 focusable" onpointerenter="announceToUser('Settings')" aria-label="Settings" data-voice-nav="settings">Settings</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main id="main-content" class="pt-32 pb-12 max-w-7xl mx-auto px-4">
    <!-- Plan Your Journey -->
    <section class="mb-12 parallax-section">
      <div class="glass-strong p-8 rounded-3xl">
        <h2 class="text-4xl font-bold mb-6 text-center" onpointerenter="announceToUser('Plan Your Journey')">
          <i class="fas fa-route text-blue-300 mr-3" aria-hidden="true"></i>
          Plan Your Journey
        </h2>
        
        <form id="journey-form" class="space-y-6">
          <!-- Location Inputs -->
          <div class="grid md:grid-cols-2 gap-6">
            <div class="slide-in-left">
              <label for="current-location" class="block text-lg font-semibold mb-3" onpointerenter="announceToUser('Start Location')">
                <i class="fas fa-map-marker-alt text-green-400 mr-2" aria-hidden="true"></i>
                Start Location
              </label>
              <div class="relative">
                <select 
                  id="current-location" 
                  class="w-full p-4 rounded-xl text-black focusable"
                  onchange="announceSelection(this, 'Start location selected')"
                  onpointerenter="announceToUser('Select your current location')"
                  aria-label="Select your current location"
                >
                  <option value="" disabled selected>Select your current location</option>
                  <option value="Adyar">Adyar</option>
                  <option value="Alwarpet">Alwarpet</option>
                  <option value="Anna Nagar">Anna Nagar</option>
                  <option value="Ashok Nagar">Ashok Nagar</option>
                  <option value="Besant Nagar">Besant Nagar</option>
                  <option value="Chetpet">Chetpet</option>
                  <option value="Chennai Central Railway Station">Chennai Central Railway Station</option>
                  <option value="Chennai International Airport">Chennai International Airport</option>
                  <option value="Chromepet">Chromepet</option>
                  <option value="Egmore">Egmore</option>
                  <option value="Express Avenue Mall">Express Avenue Mall</option>
                  <option value="Guindy">Guindy</option>
                  <option value="Kilpauk">Kilpauk</option>
                  <option value="Kodambakkam">Kodambakkam</option>
                  <option value="Koyambedu">Koyambedu</option>
                  <option value="Marina Beach">Marina Beach</option>
                  <option value="Mount Road">Mount Road</option>
                  <option value="Mylapore">Mylapore</option>
                  <option value="Nungambakkam">Nungambakkam</option>
                  <option value="Perambur">Perambur</option>
                  <option value="Phoenix MarketCity Mall">Phoenix MarketCity Mall</option>
                  <option value="Royapettah">Royapettah</option>
                  <option value="Saidapet">Saidapet</option>
                  <option value="T. Nagar">T. Nagar</option>
                  <option value="Tambaram">Tambaram</option>
                  <option value="Teynampet">Teynampet</option>
                  <option value="Thiruvanmiyur">Thiruvanmiyur</option>
                  <option value="Vadapalani">Vadapalani</option>
                  <option value="Velachery">Velachery</option>
                </select>
                <button 
                  type="button" 
                  onclick="detectLocation()" 
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-blue-300 hover:text-white transition-colors focusable"
                  aria-label="Detect current location"
                  onpointerenter="announceToUser('Detect current location')"
                >
                  <i class="fas fa-location-arrow text-xl" aria-hidden="true"></i>
                </button>
              </div>
            </div>
            
            <div class="slide-in-right">
              <label for="destination" class="block text-lg font-semibold mb-3" onpointerenter="announceToUser('Destination')">
                <i class="fas fa-flag-checkered text-red-400 mr-2" aria-hidden="true"></i>
                Destination
              </label>
              <div class="relative">
                <select 
                  id="destination" 
                  class="w-full p-4 rounded-xl text-black focusable"
                  onchange="announceSelection(this, 'Destination selected')"
                  onpointerenter="announceToUser('Select your destination')"
                  aria-label="Select your destination"
                >
                  <option value="" disabled selected>Select your destination</option>
                  <option value="Adyar">Adyar</option>
                  <option value="Alwarpet">Alwarpet</option>
                  <option value="Anna Nagar">Anna Nagar</option>
                  <option value="Ashok Nagar">Ashok Nagar</option>
                  <option value="Besant Nagar">Besant Nagar</option>
                  <option value="Chetpet">Chetpet</option>
                  <option value="Chennai Central Railway Station">Chennai Central Railway Station</option>
                  <option value="Chennai International Airport">Chennai International Airport</option>
                  <option value="Chromepet">Chromepet</option>
                  <option value="Egmore">Egmore</option>
                  <option value="Express Avenue Mall">Express Avenue Mall</option>
                  <option value="Guindy">Guindy</option>
                  <option value="Kilpauk">Kilpauk</option>
                  <option value="Kodambakkam">Kodambakkam</option>
                  <option value="Koyambedu">Koyambedu</option>
                  <option value="Marina Beach">Marina Beach</option>
                  <option value="Mount Road">Mount Road</option>
                  <option value="Mylapore">Mylapore</option>
                  <option value="Nungambakkam">Nungambakkam</option>
                  <option value="Perambur">Perambur</option>
                  <option value="Phoenix MarketCity Mall">Phoenix MarketCity Mall</option>
                  <option value="Royapettah">Royapettah</option>
                  <option value="Saidapet">Saidapet</option>
                  <option value="T. Nagar">T. Nagar</option>
                  <option value="Tambaram">Tambaram</option>
                  <option value="Teynampet">Teynampet</option>
                  <option value="Thiruvanmiyur">Thiruvanmiyur</option>
                  <option value="Vadapalani">Vadapalani</option>
                  <option value="Velachery">Velachery</option>
                </select>
                <button 
                  type="button" 
                  onclick="voiceDestinationInput()" 
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-blue-300 hover:text-white transition-colors focusable"
                  aria-label="Voice input for destination"
                  onpointerenter="announceToUser('Voice input for destination')"
                >
                  <i class="fas fa-microphone text-xl" aria-hidden="true"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Accessibility Requirements -->
          <div class="parallax-section">
            <h3 class="text-2xl font-semibold mb-4" onpointerenter="announceToUser('Accessibility Requirements')">
              <i class="fas fa-universal-access text-purple-400 mr-2" aria-hidden="true"></i>
              Accessibility Requirements
            </h3>
            <div class="grid md:grid-cols-3 gap-4">
              <label class="glass p-4 rounded-xl cursor-pointer hover-light hover:bg-blue-500/20 transition-all focusable" onpointerenter="announceToUser('Wheelchair Access')">
                <input type="checkbox" id="wheelchair-access" class="mr-3" onchange="announceCheckbox(this, 'Wheelchair Access')">
                <i class="fas fa-wheelchair text-green-400 mr-2" aria-hidden="true"></i>
                Wheelchair Access
              </label>
              <label class="glass p-4 rounded-xl cursor-pointer hover-light hover:bg-blue-500/20 transition-all focusable" onpointerenter="announceToUser('Voice Guide')">
                <input type="checkbox" id="voice-guide" class="mr-3" onchange="announceCheckbox(this, 'Voice Guide')" checked>
                <i class="fas fa-volume-up text-blue-400 mr-2" aria-hidden="true"></i>
                Voice Guide
              </label>
              <label class="glass p-4 rounded-xl cursor-pointer hover-light hover:bg-blue-500/20 transition-all focusable" onpointerenter="announceToUser('Step-Free Path')">
                <input type="checkbox" id="step-free" class="mr-3" onchange="announceCheckbox(this, 'Step-Free Path')">
                <i class="fas fa-walking text-yellow-400 mr-2" aria-hidden="true"></i>
                Step-Free Path
              </label>
            </div>
          </div>

          <!-- Find Route Button -->
          <div class="text-center parallax-section">
            <button 
              type="submit" 
              class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-12 py-4 rounded-2xl text-xl font-bold hover-light glow-primary transition-all duration-300 focusable"
              aria-label="Find accessible route"
              onclick="announceButtonClick('Find Accessible Route')"
              onpointerenter="announceToUser('Find Accessible Route')"
              data-voice-action="find route"
            >
              <i class="fas fa-search-location mr-3" aria-hidden="true"></i>
              <span id="route-button-text">Find Accessible Route</span>
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- Route Results Section -->
    <section id="route-results" class="mb-12 hidden">
      <div class="glass-strong p-8 rounded-3xl">
        <h3 class="text-3xl font-bold mb-6 text-center" onpointerenter="announceToUser('Your Accessible Route Options')">
          <i class="fas fa-route text-blue-300 mr-3" aria-hidden="true"></i>
          Your Accessible Route Options
        </h3>
        <div id="route-cards" class="space-y-6">
        </div>
      </div>
    </section>
  </main>

  <!-- Map Redirect Overlay -->
  <div id="map-overlay" class="map-redirect-overlay">
    <div class="map-redirect-content">
      <i class="fas fa-map-marked-alt text-blue-500 text-6xl mb-4 animate-pulse" aria-hidden="true"></i>
      <h3 class="text-2xl font-bold text-gray-800 mb-4">Opening Google Maps</h3>
      <p class="text-gray-600 mb-6">Your accessible route will open in Google Maps with voice navigation ready. MTC Buses and Train routes will be highlighted.</p>
      <div class="flex justify-center space-x-4">
        <button onclick="proceedToMaps()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors focusable" onpointerenter="announceToUser('Continue to Google Maps')">
          Continue
        </button>
        <button onclick="closeMapOverlay()" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors focusable" onpointerenter="announceToUser('Cancel')">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let voiceAssistanceEnabled = true;
    let currentRoute = null;
    let speechSynthesis = window.speechSynthesis;
    let speechRecognition = null;
    let lastSpokenMessage = '';
    let debounceTimeout = null;
    let recognition = null;
    let isListening = false;
    let isVoiceEnabled = false;
    let recognitionTimeout = null;
    let hasWelcomed = false;
    let currentHighlight = null;

    // Voice commands mapping
    const voiceCommands = {
      'help': () => showHelp(),
      'navigate': () => navigateToSection('main-content'),
      'navigation': () => navigateToSection('main-content'),
      'find route': () => handleRouteSearch({ preventDefault: () => {} }),
      'home': () => navigateToPage('home.html'),
      'alerts': () => navigateToPage('alerts.html'),
      'community': () => navigateToPage('community.html'),
      'settings': () => navigateToPage('settings.html'),
      'start navigation': () => startNavigationForVoice(),
      'stop': () => stopCurrentAction()
    };

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      loadUserPreferences();
      setupParallaxScrolling();
      detectLocation();
      setupSpeechRecognition();
      initializeVoices();
      if (checkSpeechSupport()) {
        setTimeout(() => {
          startVoiceMode();
        }, 1000);
      }
      announceVoiceGuideOnboarding();
    });

    function initializeApp() {
      const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible', 'show');
            if (voiceAssistanceEnabled) {
              announceToUser(`Section in view: ${entry.target.querySelector('h2, h3')?.textContent || 'Content section'}`);
            }
          }
        });
      }, observerOptions);

      document.querySelectorAll('.parallax-section, .slide-in-left, .slide-in-right').forEach(el => {
        observer.observe(el);
      });

      document.getElementById('journey-form').addEventListener('submit', handleRouteSearch);
      document.getElementById('journey-form').addEventListener('click', (e) => {
        if (e.target.closest('button[type="submit"]')) {
          announceButtonClick('Find Accessible Route');
        }
      });

      // Handle anchor links
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
          e.preventDefault();
          const targetId = this.getAttribute('href').substring(1);
          const targetElement = document.getElementById(targetId);
          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth' });
            highlightElement(targetElement);
            setTimeout(() => {
              announceToUser(`Opened ${this.textContent}`);
            }, 300);
          }
        });
      });
    }

    // Check browser support for speech recognition
    function checkSpeechSupport() {
      if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) {
        console.warn('Speech recognition not supported');
        announceToUser('Speech recognition not supported on this browser. Please use manual input.');
        return false;
      }
      return true;
    }

    // Initialize speech recognition with continuous listening
    function initializeSpeechRecognition() {
      if (!checkSpeechSupport()) return false;

      try {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-IN';
        recognition.maxAlternatives = 1;

        recognition.onstart = function() {
          console.log('Speech recognition started');
          isListening = true;
          showSpeechDisplay('Listening...');
          
          if (!hasWelcomed) {
            setTimeout(() => {
              announceToUser('Welcome to voice mode on the Navigate page. Say help for available commands.');
              hasWelcomed = true;
            }, 500);
          }
          
          if (recognitionTimeout) {
            clearTimeout(recognitionTimeout);
            recognitionTimeout = null;
          }
        };

        recognition.onresult = function(event) {
          let interimTranscript = '';
          let finalTranscript = '';
          
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript;
            } else {
              interimTranscript += transcript;
            }
          }

          if (interimTranscript) {
            showSpeechDisplay(interimTranscript);
          }

          if (finalTranscript) {
            console.log('Final transcript:', finalTranscript);
            showSpeechDisplay(`"${finalTranscript}"`);
            processVoiceCommand(finalTranscript.toLowerCase().trim());
            
            setTimeout(() => {
              showSpeechDisplay('Listening...');
            }, 2000);
          }
        };

        recognition.onerror = function(event) {
          console.error('Speech recognition error:', event.error);
          isListening = false;
          
          let errorMessage = 'Recognition error occurred';
          let shouldRestart = true;
          
          switch (event.error) {
            case 'no-speech':
              errorMessage = 'No speech detected. Still listening...';
              shouldRestart = true;
              break;
            case 'not-allowed':
              errorMessage = 'Microphone access denied. Please enable microphone permissions.';
              isVoiceEnabled = false;
              shouldRestart = false;
              break;
            case 'network':
              errorMessage = 'Network error. Retrying in 2 seconds...';
              shouldRestart = true;
              break;
            case 'aborted':
              errorMessage = 'Recognition stopped. Restarting...';
              shouldRestart = true;
              break;
            default:
              errorMessage = `Recognition error: ${event.error}. Restarting...`;
              shouldRestart = true;
          }
          
          hideSpeechDisplay();
          
          if (shouldRestart && isVoiceEnabled) {
            setTimeout(() => {
              if (!isListening && isVoiceEnabled) {
                console.log('Auto-restarting recognition...');
                try {
                  recognition.start();
                } catch (e) {
                  console.error('Failed to restart recognition:', e);
                }
              }
            }, event.error === 'network' ? 2000 : 1000);
          }
        };

        recognition.onend = function() {
          console.log('Speech recognition ended');
          isListening = false;
          hideSpeechDisplay();
          
          if (isVoiceEnabled) {
            setTimeout(() => {
              if (!isListening && isVoiceEnabled) {
                console.log('Auto-restarting recognition to maintain continuous listening...');
                try {
                  recognition.start();
                } catch (e) {
                  console.error('Failed to restart recognition:', e);
                }
              }
            }, 500);
          }
        };

        return true;
      } catch (error) {
        console.error('Failed to initialize speech recognition:', error);
        return false;
      }
    }

    // Show speech display
    function showSpeechDisplay(text) {
      const display = document.getElementById('speechDisplay');
      const textElement = document.getElementById('speechText');
      textElement.textContent = text;
      display.classList.add('visible');
    }

    // Hide speech display
    function hideSpeechDisplay() {
      const display = document.getElementById('speechDisplay');
      display.classList.remove('visible');
    }

    // Process voice commands
    function processVoiceCommand(command) {
      console.log('Processing command:', command);
      
      let matchedCommand = null;
      let bestMatch = '';
      
      for (const [key, func] of Object.entries(voiceCommands)) {
        if (command === key || command.includes(key)) {
          if (key.length > bestMatch.length) {
            matchedCommand = func;
            bestMatch = key;
          }
        }
      }

      if (matchedCommand) {
        matchedCommand();
      } else {
        setTimeout(() => {
          announceToUser('Command not found. Say help for available commands.');
        }, 200);
      }
    }

    // Navigate to external page
    function navigateToPage(page) {
      announceToUser(`Navigating to ${page.replace('.html', '')} page`);
      setTimeout(() => {
        window.location.href = page;
      }, 1000);
    }

    // Navigate to section
    function navigateToSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.scrollIntoView({ behavior: 'smooth' });
        highlightElement(section);
        announceToUser(`Navigating to ${sectionId === 'main-content' ? 'Plan Your Journey' : sectionId} section`);
      } else {
        announceToUser(`Section ${sectionId} not found`);
      }
    }

    // Start navigation for voice command
    function startNavigationForVoice() {
      if (currentRoute !== null) {
        startNavigation(currentRoute);
      } else {
        announceToUser('No route selected. Please find a route first.');
      }
    }

    // Stop current action
    function stopCurrentAction() {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      clearTimeout(recognitionTimeout);
      closeMapOverlay();
      removeHighlight();
      announceToUser('All actions stopped');
    }

    // Highlight element
    function highlightElement(element) {
      removeHighlight();
      element.classList.add('voice-highlight');
      currentHighlight = element;
      setTimeout(removeHighlight, 3000);
    }

    // Remove highlight
    function removeHighlight() {
      if (currentHighlight) {
        currentHighlight.classList.remove('voice-highlight');
        currentHighlight = null;
      }
    }

    // Show help
    function showHelp() {
      const commandsPanel = document.getElementById('voiceCommands');
      commandsPanel.classList.remove('hidden');
      
      setTimeout(() => {
        announceToUser('Available voice commands are: Say Help to show commands. Say Navigate to plan a journey. Say Home to go to home page. Say Alerts to go to alerts page. Say Community to go to community page. Say Settings to go to settings page. Say Start Navigation to begin navigation for a selected route. Say Find Route to search for routes. Say Stop to stop current action.');
      }, 200);
      
      highlightElement(commandsPanel);
    }

    // Toggle commands panel
    function toggleCommandsPanel() {
      const commandsPanel = document.getElementById('voiceCommands');
      commandsPanel.classList.toggle('hidden');
      const isVisible = !commandsPanel.classList.contains('hidden');
      
      setTimeout(() => {
        announceToUser(isVisible ? 'Commands shown' : 'Commands hidden');
      }, 200);
    }

    // Start voice mode
    function startVoiceMode() {
      if (!isVoiceEnabled) {
        if (initializeSpeechRecognition()) {
          isVoiceEnabled = true;
          setTimeout(() => {
            if (!isListening) {
              try {
                recognition.start();
              } catch (e) {
                console.error('Failed to start initial recognition:', e);
              }
            }
          }, 500);
        }
      }
    }

    // Stop voice mode
    function stopVoiceMode() {
      isVoiceEnabled = false;
      hasWelcomed = false;
      if (recognition && isListening) {
        recognition.stop();
      }
      speechSynthesis.cancel();
      hideSpeechDisplay();
      announceToUser('Voice mode deactivated');
    }

    function setupSpeechRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        speechRecognition = new SpeechRecognition();
        speechRecognition.continuous = false;
        speechRecognition.interimResults = false;
        speechRecognition.lang = 'en-IN';
      }
    }

    function setupParallaxScrolling() {
      window.addEventListener('scroll', () => {
        const scrolled = window.pageYOffset;
        const parallax = document.querySelectorAll('.parallax-section');
        
        parallax.forEach((element, index) => {
          const rate = scrolled * -0.5;
          element.style.transform = `translateY(${rate * 0.1}px)`;
        });
      });
    }

    function loadUserPreferences() {
      if (typeof(Storage) !== "undefined") {
        const voiceEnabled = sessionStorage.getItem('voiceAssistanceEnabled');
        if (voiceEnabled === 'true') {
          voiceAssistanceEnabled = true;
          document.getElementById('voice-guide').checked = true;
        }
      }
    }

    function detectLocation() {
      const locationSelect = document.getElementById('current-location');
      
      if (navigator.geolocation) {
        locationSelect.disabled = true;
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const chennaiLocations = [
              'Adyar', 'Alwarpet', 'Anna Nagar', 'Ashok Nagar', 'Besant Nagar', 'Chetpet',
              'Chennai Central Railway Station', 'Chennai International Airport', 'Chromepet',
              'Egmore', 'Express Avenue Mall', 'Guindy', 'Kilpauk', 'Kodambakkam', 'Koyambedu',
              'Marina Beach', 'Mount Road', 'Mylapore', 'Nungambakkam', 'Perambur',
              'Phoenix MarketCity Mall', 'Royapettah', 'Saidapet', 'T. Nagar', 'Tambaram',
              'Teynampet', 'Thiruvanmiyur', 'Vadapalani', 'Velachery'
            ];
            const randomLocation = chennaiLocations[Math.floor(Math.random() * chennaiLocations.length)];
            
            locationSelect.value = randomLocation;
            locationSelect.disabled = false;
            if (voiceAssistanceEnabled) {
              announceToUser(`Current location detected: ${randomLocation}`);
            }
          },
          (error) => {
            locationSelect.disabled = false;
            if (voiceAssistanceEnabled) {
              announceToUser('Could not detect your location. Please select your starting point.');
            }
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000
          }
        );
      } else {
        if (voiceAssistanceEnabled) {
          announceToUser('Geolocation not supported on this device. Please select your location.');
        }
      }
    }

    function voiceDestinationInput() {
      if (!speechRecognition) {
        if (voiceAssistanceEnabled) {
          announceToUser('Voice input not supported on this browser. Please select your destination.');
        }
        return;
      }

      const destinationSelect = document.getElementById('destination');
      const micButton = event.target.closest('button');
      
      micButton.innerHTML = '<i class="fas fa-circle text-red-500 animate-pulse"></i>';
      if (voiceAssistanceEnabled) {
        announceToUser('Listening for your destination. Please speak clearly.');
      }

      speechRecognition.onstart = () => {
        destinationSelect.disabled = true;
        destinationSelect.style.border = '2px solid #ef4444';
      };

      speechRecognition.onresult = (event) => {
        const result = event.results[0][0].transcript;
        const chennaiLocations = [
          'Adyar', 'Alwarpet', 'Anna Nagar', 'Ashok Nagar', 'Besant Nagar', 'Chetpet',
          'Chennai Central Railway Station', 'Chennai International Airport', 'Chromepet',
          'Egmore', 'Express Avenue Mall', 'Guindy', 'Kilpauk', 'Kodambakkam', 'Koyambedu',
          'Marina Beach', 'Mount Road', 'Mylapore', 'Nungambakkam', 'Perambur',
          'Phoenix MarketCity Mall', 'Royapettah', 'Saidapet', 'T. Nagar', 'Tambaram',
          'Teynampet', 'Thiruvanmiyur', 'Vadapalani', 'Velachery'
        ];
        const matchedLocation = chennaiLocations.find(loc => 
          loc.toLowerCase().includes(result.toLowerCase())
        ) || result;
        
        destinationSelect.value = matchedLocation;
        destinationSelect.style.border = '2px solid #10b981';
        if (voiceAssistanceEnabled) {
          announceToUser(`Destination set to: ${matchedLocation}`);
        }
        destinationSelect.disabled = false;
      };

      speechRecognition.onerror = () => {
        if (voiceAssistanceEnabled) {
          announceToUser('Voice recognition error. Please try again or select your destination.');
        }
        resetVoiceInput();
      };

      speechRecognition.onend = () => {
        resetVoiceInput();
      };

      function resetVoiceInput() {
        micButton.innerHTML = '<i class="fas fa-microphone text-xl"></i>';
        destinationSelect.style.border = '';
        destinationSelect.disabled = false;
      }

      speechRecognition.start();
    }

    function announceSelection(element, type) {
      if (voiceAssistanceEnabled) {
        announceToUser(`${type}: ${element.value}`);
      }
    }

    function announceCheckbox(element, label) {
      if (voiceAssistanceEnabled) {
        announceToUser(`${label} ${element.checked ? 'enabled' : 'disabled'}`);
      }
    }

    function announceButtonClick(label) {
      if (voiceAssistanceEnabled) {
        announceToUser(`You clicked ${label}`);
      }
    }

    function handleRouteSearch(event) {
      event.preventDefault();
      
      const currentLocation = document.getElementById('current-location').value;
      const destination = document.getElementById('destination').value;
      
      if (!destination) {
        if (voiceAssistanceEnabled) {
          announceToUser('Please select your destination before searching for routes.');
        }
        document.getElementById('destination').focus();
        return;
      }

      if (!currentLocation) {
        if (voiceAssistanceEnabled) {
          announceToUser('Please select your starting location before searching for routes.');
        }
        document.getElementById('current-location').focus();
        return;
      }

      const routeButton = document.getElementById('route-button-text');
      routeButton.innerHTML = '<div class="loading-spinner mr-2"></div> Finding Routes...';
      
      if (voiceAssistanceEnabled) {
        announceToUser('Searching for accessible routes. Please wait...');
      }

      setTimeout(() => {
        displayRouteOptions(currentLocation, destination);
        routeButton.textContent = 'Find Accessible Route';
      }, 2500);
    }

    function displayRouteOptions(start, end) {
      const routeResults = document.getElementById('route-results');
      const routeCards = document.getElementById('route-cards');
      
      const accessibilityOptions = {
        wheelchair: document.getElementById('wheelchair-access').checked,
        voiceGuide: document.getElementById('voice-guide').checked,
        stepFree: document.getElementById('step-free').checked
      };

      const routes = generateRoutes(start, end, accessibilityOptions);
      
      routeCards.innerHTML = routes.map((route, index) => `
        <div class="route-card glass-strong p-6 rounded-2xl hover-light" data-route-index="${index}" onpointerenter="announceToUser('${route.name}')">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h4 class="text-2xl font-bold text-blue-300 mb-2">
                <i class="fas fa-${route.icon} mr-2" aria-hidden="true"></i>
                ${route.name}
              </h4>
              <p class="text-blue-200">${route.description}</p>
            </div>
            <div class="text-right">
              <div class="text-3xl font-bold text-green-400">${route.duration}</div>
              <div class="text-sm text-blue-300">${route.distance} â€¢ ${route.cost}</div>
            </div>
          </div>
          
          <div class="mb-4">
            <div class="flex items-center mb-3">
              <div class="flex text-yellow-400">
                ${Array(route.accessibilityRating).fill('<i class="fas fa-star"></i>').join('')}
                ${Array(5 - route.accessibilityRating).fill('<i class="far fa-star"></i>').join('')}
              </div>
              <span class="ml-2 text-sm text-blue-200">Accessibility Rating</span>
            </div>
            <div class="flex flex-wrap gap-2">
              ${route.features.map(feature => `
                <span class="px-3 py-1 bg-blue-500/30 text-blue-200 rounded-full text-sm border border-blue-400/30">
                  <i class="fas fa-check mr-1" aria-hidden="true"></i>${feature}
                </span>
              `).join('')}
            </div>
          </div>

          <div class="mb-6">
            <h5 class="font-semibold mb-3 text-blue-300">Route Steps:</h5>
            <div class="space-y-2">
              ${route.steps.map((step, stepIndex) => `
                <div class="flex items-start p-2 glass rounded-lg">
                  <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm mr-3 mt-0.5 flex-shrink-0">
                    ${stepIndex + 1}
                  </span>
                  <span class="text-blue-100">${step}</span>
                </div>
              `).join('')}
            </div>
          </div>

          <div class="flex flex-wrap gap-3">
            <button 
              onclick="startNavigation(${index})"
              class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-xl font-semibold hover-light glow-accent transition-all flex items-center focusable"
              aria-label="Start navigation for ${route.name}"
              onpointerenter="announceToUser('Start Navigation')"
              data-voice-action="start navigation"
            >
              <i class="fas fa-route mr-2" aria-hidden="true"></i>
              Start Navigation
            </button>
            <button 
              onclick="shareRoute(${index})"
              class="glass px-6 py-3 rounded-xl font-semibold hover-light transition-all flex items-center focusable"
              aria-label="Share ${route.name}"
              onpointerenter="announceToUser('Share Route')"
            >
              <i class="fas fa-share-alt mr-2" aria-hidden="true"></i>
              Share Route
            </button>
            <button 
              onclick="saveRoute(${index})"
              class="glass px-6 py-3 rounded-xl font-semibold hover-light transition-all flex items-center focusable"
              aria-label="Save ${route.name}"
              onpointerenter="announceToUser('Save Route')"
            >
              <i class="fas fa-bookmark mr-2" aria-hidden="true"></i>
              Save Route
            </button>
          </div>
        </div>
      `).join('');

      routeResults.classList.remove('hidden');
      routeResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      setTimeout(() => {
        document.querySelectorAll('.route-card').forEach((card, index) => {
          setTimeout(() => {
            card.classList.add('show');
            if (voiceAssistanceEnabled) {
              announceToUser(`Route option ${index + 1}: ${card.querySelector('h4').textContent}`);
            }
          }, index * 200);
        });
      }, 300);

      if (voiceAssistanceEnabled) {
        announceToUser(`Found ${routes.length} accessible route options. Use tab to navigate through the options or say Start Navigation to begin.`);
      }
    }

    function generateRoutes(start, end, options) {
      const baseRoutes = [
        {
          name: 'Chennai Metro + Walk',
          description: 'Fastest route using accessible metro system',
          icon: 'subway',
          duration: '28 min',
          distance: '12.8 km',
          cost: 'â‚¹25-35',
          accessibilityRating: options.wheelchair ? 5 : 4,
          features: ['Wheelchair Access', 'Audio Announcements', 'Tactile Paths', 'Elevator Access'],
          steps: [
            `Walk 3 minutes from ${start} to nearest Metro station`,
            'Board Blue Line Metro (wheelchair accessible coach available)',
            'Travel 8 stations with Tamil & English announcements',
            'Transfer at Central Metro Station using accessible walkway',
            'Continue on Green Line for 4 more stations',
            `Exit using elevator and walk 5 minutes to ${end} via tactile pathway`
          ],
          transitMode: 'rail'
        },
        {
          name: 'MTC Low-Floor Bus',
          description: 'Direct bus route with accessibility features',
          icon: 'bus',
          duration: '42 min',
          distance: '15.2 km',
          cost: 'â‚¹8-12',
          accessibilityRating: options.wheelchair ? 4 : 3,
          features: ['Low-Floor Entry', 'Priority Seating', 'Audio Stops', 'Wheelchair Space'],
          steps: [
            `Walk 2 minutes to bus stop near ${start}`,
            'Board MTC Route 21G (wheelchair accessible low-floor bus)',
            'Audio announcements will announce each stop in Tamil and English',
            'Enjoy priority seating and wheelchair accommodation',
            `Request stop announcement 2 stops before ${end}`,
            `Exit using rear ramp and walk 3 minutes to destination`
          ],
          transitMode: 'bus'
        },
        {
          name: 'Mixed Transport (Optimized)',
          description: 'Combination of metro and bus for best accessibility',
          icon: 'route',
          duration: '35 min',
          distance: '13.5 km',
          cost: 'â‚¹20-30',
          accessibilityRating: options.stepFree ? 5 : 4,
          features: ['Full Accessibility Chain', 'Covered Walkways', 'Audio Guidance', 'Step-Free'],
          steps: [
            `Share auto to Metro station (wheelchair accessible vehicle available)`,
            'Take Metro Blue Line with full accessibility features',
            'Walk through covered accessible bridge to bus terminal',
            'Board connecting MTC bus with low-floor entry',
            'Audio navigation continues throughout journey',
            `Arrive at ${end} via accessible drop-off point`
          ],
          transitMode: 'bus,rail'
        }
      ];

      let filteredRoutes = baseRoutes;
      
      if (options.wheelchair) {
        filteredRoutes = filteredRoutes.filter(route => 
          route.features.includes('Wheelchair Access') || 
          route.features.includes('Low-Floor Entry') ||
          route.features.includes('Full Accessibility Chain')
        );
      }

      if (options.stepFree) {
        filteredRoutes = filteredRoutes.filter(route => 
          route.features.includes('Step-Free') || 
          route.features.includes('Elevator Access')
        );
      }

      return filteredRoutes.sort((a, b) => b.accessibilityRating - a.accessibilityRating);
    }

    function startNavigation(routeIndex) {
      const routeCard = document.querySelector(`[data-route-index="${routeIndex}"]`);
      routeCard.classList.add('selected');
      
      currentRoute = routeIndex;
      
      if (voiceAssistanceEnabled) {
        announceToUser('Starting Navigation. Opening Google Maps with voice guidance enabled...');
      } else {
        announceToUser('Starting Navigation. Opening Google Maps...');
      }

      document.getElementById('map-overlay').style.display = 'flex';
      
      setTimeout(() => {
        routeCard.classList.remove('selected');
      }, 800);
    }

    function proceedToMaps() {
      const start = document.getElementById('current-location').value;
      const end = document.getElementById('destination').value;
      const routeCard = document.querySelector(`[data-route-index="${currentRoute}"]`);
      const transitMode = routeCard ? generateRoutes(start, end, {
        wheelchair: document.getElementById('wheelchair-access').checked,
        voiceGuide: document.getElementById('voice-guide').checked,
        stepFree: document.getElementById('step-free').checked
      })[currentRoute].transitMode : 'bus,rail';
      
      const mapsUrl = `https://www.google.com/maps/dir/${encodeURIComponent(start)}/${encodeURIComponent(end)}/?travelmode=transit&transit_mode=${transitMode}&dirflg=r`;
      
      window.open(mapsUrl, '_blank');
      
      if (voiceAssistanceEnabled) {
        announceToUser('Google Maps opened with your accessible route. MTC Buses and Train routes are highlighted with voice navigation ready.');
      }
      
      closeMapOverlay();
    }

    function closeMapOverlay() {
      document.getElementById('map-overlay').style.display = 'none';
      if (voiceAssistanceEnabled) {
        announceToUser('Map overlay closed.');
      }
    }

    function shareRoute(routeIndex) {
      const shareText = `Check out this accessible route I found in Chennai using Accessible Chennai app!`;
      
      if (navigator.share) {
        navigator.share({
          title: 'Accessible Route - Chennai',
          text: shareText,
          url: window.location.href
        }).then(() => {
          if (voiceAssistanceEnabled) {
            announceToUser('Route shared successfully!');
          }
        }).catch(() => {
          fallbackShare(shareText);
        });
      } else {
        fallbackShare(shareText);
      }
    }

    function fallbackShare(text) {
      if (navigator.clipboard) {
        const shareUrl = `${window.location.href}?route=${currentRoute}`;
        navigator.clipboard.writeText(`${text} ${shareUrl}`).then(() => {
          if (voiceAssistanceEnabled) {
            announceToUser('Route link copied to clipboard!');
          }
        });
      } else {
        if (voiceAssistanceEnabled) {
          announceToUser('Sharing not supported. You can manually copy the page URL to share.');
        }
      }
    }

    function saveRoute(routeIndex) {
      const routeName = document.querySelector(`[data-route-index="${routeIndex}"] h4`).textContent.trim();
      
      if (typeof(Storage) !== "undefined") {
        let savedRoutes = JSON.parse(localStorage.getItem('savedRoutes') || '[]');
        const routeData = {
          index: routeIndex,
          name: routeName,
          start: document.getElementById('current-location').value,
          end: document.getElementById('destination').value,
          timestamp: new Date().toISOString()
        };
        
        savedRoutes.push(routeData);
        localStorage.setItem('savedRoutes', JSON.stringify(savedRoutes));
        
        if (voiceAssistanceEnabled) {
          announceToUser(`Route "${routeName}" saved to your favorites!`);
        }
      } else {
        if (voiceAssistanceEnabled) {
          announceToUser('Route saved! (Note: Browser storage not available)');
        }
      }
    }

    function announceVoiceGuideOnboarding() {
      if (localStorage.getItem('voiceGuideOnboarded') !== 'true') {
        const welcomeMessage = 'Welcome to Navigate page. I am here to help you.';
        const optionsMessage = [
          'Available options on this page include:',
          'Navigation links: Home, Navigate, Community, Alerts, Settings.',
          'Plan Your Journey section with:',
          '- Start Location dropdown to select your current location or use the Detect Location button.',
          '- Destination dropdown to select your destination or use voice input.',
          'Accessibility Requirements with checkboxes for Wheelchair Access, Voice Guide (currently enabled), and Step-Free Path.',
          'Find Accessible Route button to search for routes.',
          'Use Tab to navigate through options or voice commands like "Navigate to destination" to select a destination.'
        ].join(' ');

        announceToUser(`${welcomeMessage} ${optionsMessage}`);
        localStorage.setItem('voiceGuideOnboarded', 'true');
      }
    }

    function announceToUser(message) {
      if (message === lastSpokenMessage) return;

      clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(() => {
        speechSynthesis.cancel();
        
        const announcement = document.createElement('div');
        announcement.setAttribute('aria-live', 'polite');
        announcement.setAttribute('aria-atomic', 'true');
        announcement.className = 'sr-only';
        announcement.textContent = message;
        document.body.appendChild(announcement);
        
        setTimeout(() => {
          document.body.removeChild(announcement);
        }, 1000);

        if (voiceAssistanceEnabled && speechSynthesis) {
          const utterance = new SpeechSynthesisUtterance(message);
          utterance.rate = 0.9;
          utterance.pitch = 1.0;
          utterance.volume = 1.0;
          utterance.lang = 'en-IN';

          const voices = speechSynthesis.getVoices();
          if (voices.length > 0) {
            const preferredVoice = voices.find(voice => 
              voice.lang === 'en-IN' && voice.localService && voice.name.includes('Enhanced')
            ) || voices.find(voice => 
              voice.lang === 'en-IN' && voice.localService
            ) || voices.find(voice => 
              voice.lang.startsWith('en-') && voice.localService
            ) || voices.find(voice => 
              voice.lang === 'en-IN'
            );
            
            if (preferredVoice) {
              utterance.voice = preferredVoice;
              console.log('Using voice:', preferredVoice.name);
            }
          }

          speechSynthesis.speak(utterance);
          lastSpokenMessage = message;
        }
      }, 150);
    }

    // Initialize voices
    function initializeVoices() {
      if (speechSynthesis) {
        speechSynthesis.getVoices();
        
        if (speechSynthesis.onvoiceschanged !== undefined) {
          speechSynthesis.onvoiceschanged = () => {
            const voices = speechSynthesis.getVoices();
            console.log('Voices loaded:', voices.length);
          };
        }
      }
    }

    document.addEventListener('keydown', (event) => {
      if (event.altKey && event.key === 'l') {
        event.preventDefault();
        detectLocation();
      }
      
      if (event.altKey && event.key === 's') {
        event.preventDefault();
        voiceDestinationInput();
      }
      
      if (event.key === 'Escape') {
        closeMapOverlay();
      }
    });

    window.addEventListener('focus', (event) => {
      if (event.target.matches('button, input, select, textarea, a')) {
        event.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        if (voiceAssistanceEnabled) {
          const label = event.target.getAttribute('aria-label') || 
                       event.target.textContent.trim() || 
                       'Focused element';
          announceToUser(`Focused: ${label}`);
        }
      }
    }, true);

    window.addEventListener('beforeunload', () => {
      if (speechRecognition) {
        speechRecognition.stop();
      }
      if (recognition && isListening) {
        recognition.stop();
      }
      if (speechSynthesis && speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
    });

    // Global error handler
    window.addEventListener('error', function(e) {
      console.error('Global error:', e);
      if (e.message && e.message.includes('speech')) {
        // Suppress speech-related errors from stopping execution
      }
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {
        console.log('Service worker registration failed - offline features may not work');
      });
    }
  </script> 
</body>
</html>